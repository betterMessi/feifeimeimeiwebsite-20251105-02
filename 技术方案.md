# 照片视频共享系统 - 详细技术方案

## 一、技术栈选择

### 1.1 前端技术栈
- **框架**：Vue 3.4+（Composition API）
- **构建工具**：Vite 5.0+（快速构建，HMR）
- **UI组件库**：Element Plus 2.4+（中文文档完善，组件丰富）
- **状态管理**：Pinia 2.1+（Vue官方推荐，轻量级）
- **路由**：Vue Router 4.0+
- **HTTP客户端**：Axios 1.6+
- **图片预览**：vue-photo-preview 或 v-viewer
- **视频播放**：video.js 或 @videojs/video.js
- **日期处理**：dayjs
- **工具库**：lodash-es

### 1.2 后端技术栈
- **运行时**：Node.js 18+ LTS
- **框架**：Express 4.18+（成熟稳定）
- **ORM**：Prisma 5.0+（现代化，类型安全）
- **数据库**：PostgreSQL 15+（性能好，支持JSON）
- **文件上传**：multer 1.4+（处理multipart/form-data）
- **认证**：jsonwebtoken + bcryptjs
- **验证**：express-validator
- **CORS**：cors
- **环境变量**：dotenv

### 1.3 存储方案
- **主存储**：云对象存储（推荐：阿里云OSS 或 腾讯云COS）
  - 优点：高可用、CDN加速、自动备份
  - 成本：按量付费，约0.12元/GB/月
- **本地缓存**：服务器本地临时存储（上传时）
- **缩略图**：生成缩略图并存储（优化加载速度）

### 1.4 部署方案
- **容器化**：Docker + Docker Compose
- **Web服务器**：Nginx（反向代理、静态资源）
- **进程管理**：PM2（Node.js进程管理）
- **数据库**：PostgreSQL容器
- **云服务器**：推荐配置
  - CPU：2核+
  - 内存：4GB+
  - 存储：50GB+（系统盘）+ 云存储（按需）
  - 带宽：3Mbps+

### 1.5 开发工具
- **代码规范**：ESLint + Prettier
- **Git**：版本控制
- **API文档**：Swagger/OpenAPI（可选）

---

## 二、系统架构设计

### 2.1 整体架构
```
┌─────────────────┐
│   用户浏览器     │
│  (Vue 3 前端)   │
└────────┬────────┘
         │ HTTPS
         ▼
┌─────────────────┐
│   Nginx (80/443) │ 反向代理
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌──────────┐
│ 静态资源 │ │ Express  │
│ (Nginx) │ │ 后端API  │
└─────────┘ └────┬─────┘
                 │
         ┌───────┴───────┐
         │               │
         ▼               ▼
  ┌──────────┐    ┌──────────┐
  │PostgreSQL│    │ 云存储OSS │
  │  数据库   │    │  对象存储 │
  └──────────┘    └──────────┘
```

### 2.2 目录结构
```
photo-sharing-system/
├── frontend/                    # 前端项目
│   ├── public/                 # 静态资源
│   ├── src/
│   │   ├── assets/             # 资源文件
│   │   ├── components/         # 公共组件
│   │   │   ├── common/         # 通用组件
│   │   │   ├── layout/         # 布局组件
│   │   │   └── media/          # 媒体相关组件
│   │   ├── views/              # 页面组件
│   │   ├── router/             # 路由配置
│   │   ├── store/              # Pinia状态管理
│   │   ├── api/                # API接口
│   │   ├── utils/              # 工具函数
│   │   ├── styles/             # 样式文件
│   │   └── main.js             # 入口文件
│   ├── .env.development        # 开发环境变量
│   ├── .env.production         # 生产环境变量
│   ├── vite.config.js          # Vite配置
│   └── package.json
│
├── backend/                     # 后端项目
│   ├── src/
│   │   ├── controllers/        # 控制器
│   │   ├── services/           # 业务逻辑
│   │   ├── models/             # 数据模型（Prisma）
│   │   ├── middleware/         # 中间件
│   │   ├── routes/             # 路由
│   │   ├── utils/              # 工具函数
│   │   ├── config/             # 配置文件
│   │   └── app.js              # Express应用
│   ├── prisma/                 # Prisma配置
│   │   ├── schema.prisma       # 数据库模型
│   │   └── migrations/         # 迁移文件
│   ├── uploads/                # 临时上传目录
│   ├── .env                    # 环境变量
│   ├── server.js               # 服务器入口
│   └── package.json
│
├── docker/                      # Docker配置
│   ├── Dockerfile.frontend     # 前端镜像
│   ├── Dockerfile.backend      # 后端镜像
│   └── docker-compose.yml      # 容器编排
│
├── nginx/                       # Nginx配置
│   └── nginx.conf
│
├── docs/                        # 文档
│   ├── API.md                  # API文档
│   └── DEPLOYMENT.md           # 部署文档
│
└── README.md
```

---

## 三、数据库设计

### 3.1 表结构（Prisma Schema）

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  password  String   @db.VarChar(255) // bcrypt加密
  nickname  String?  @db.VarChar(100)
  avatar    String?  @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  media     Media[]
  
  @@map("users")
}

// 媒体文件表
model Media {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  filename    String   @db.VarChar(255)
  originalName String  @db.VarChar(255) @map("original_name")
  filePath    String   @db.VarChar(500) @map("file_path") // 云存储URL
  thumbnailPath String? @db.VarChar(500) @map("thumbnail_path") // 缩略图URL
  fileType    String   @db.VarChar(20) @map("file_type") // 'image' | 'video'
  mimeType    String   @db.VarChar(100) @map("mime_type")
  fileSize    BigInt   @map("file_size") // 字节
  width       Int?     // 图片/视频宽度
  height      Int?     // 图片/视频高度
  duration    Int?     // 视频时长（秒）
  description String?  @db.Text
  uploadTime  DateTime @default(now()) @map("upload_time")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user        User     @relation(fields: [userId], references: [id])
  tags        MediaTag[]
  
  @@index([userId])
  @@index([uploadTime])
  @@index([fileType])
  @@map("media")
}

// 标签表
model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(50)
  color     String   @default("#409EFF") @db.VarChar(20) // 标签颜色
  icon      String?  @db.VarChar(50) // 图标（可选）
  createdAt DateTime @default(now()) @map("created_at")
  
  media     MediaTag[]
  
  @@map("tags")
}

// 媒体-标签关联表（多对多）
model MediaTag {
  id      Int   @id @default(autoincrement())
  mediaId Int   @map("media_id")
  tagId   Int   @map("tag_id")
  
  media   Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  tag     Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([mediaId, tagId])
  @@index([tagId])
  @@map("media_tags")
}
```

---

## 四、API接口设计

### 4.1 认证相关
```
POST   /api/auth/register      # 注册（可选，初期可手动创建用户）
POST   /api/auth/login          # 登录
POST   /api/auth/logout         # 登出
GET    /api/auth/me             # 获取当前用户信息
POST   /api/auth/refresh        # 刷新Token
```

### 4.2 媒体文件相关
```
POST   /api/media/upload        # 上传文件（支持多文件）
GET    /api/media              # 获取媒体列表（支持分页、筛选）
GET    /api/media/:id          # 获取单个媒体详情
DELETE /api/media/:id          # 删除媒体
PUT    /api/media/:id          # 更新媒体信息（描述、标签等）
GET    /api/media/timeline     # 获取时间线（按时间倒序）
GET    /api/media/by-tag/:tagId # 按标签获取媒体
```

### 4.3 标签相关
```
GET    /api/tags               # 获取所有标签
POST   /api/tags               # 创建标签
PUT    /api/tags/:id           # 更新标签
DELETE /api/tags/:id           # 删除标签
```

### 4.4 统计相关（可选）
```
GET    /api/stats/dashboard    # 仪表盘统计（总数、分类统计等）
```

---

## 五、前端页面设计

### 5.1 路由结构
```
/                     # 主页（简介、导航）
  ├── /login          # 登录页
  ├── /timeline       # 时间线视图
  ├── /category       # 分类视图
  │   └── /category/:tagId  # 具体分类
  ├── /gallery        # 图库浏览
  │   └── /gallery/:id      # 媒体详情
  └── /upload         # 上传页面
```

### 5.2 页面组件
- **Home.vue**：主页，包含简介、快速导航、统计信息
- **Login.vue**：登录页面
- **Timeline.vue**：时间线视图，瀑布流布局
- **Category.vue**：分类视图，标签云 + 媒体列表
- **Gallery.vue**：媒体详情页，支持预览、切换
- **Upload.vue**：上传页面，拖拽上传、标签选择

### 5.3 公共组件
- **Layout.vue**：主布局（头部导航、侧边栏）
- **MediaCard.vue**：媒体卡片（缩略图、标签、时间）
- **MediaViewer.vue**：媒体查看器（图片预览、视频播放）
- **UploadModal.vue**：上传弹窗
- **TagSelector.vue**：标签选择器
- **Pagination.vue**：分页组件

---

## 六、核心功能实现要点

### 6.1 文件上传
- **前端**：
  - 支持拖拽上传
  - 多文件选择
  - 上传进度显示
  - 文件类型和大小验证
  - 图片预览（上传前）

- **后端**：
  - 使用multer处理multipart/form-data
  - 文件大小限制（如：单文件50MB）
  - 文件类型验证
  - 生成唯一文件名（UUID）
  - 上传到云存储
  - 生成缩略图（图片）
  - 提取视频信息（时长、分辨率）
  - 保存元数据到数据库

### 6.2 图片处理
- 使用sharp库（Node.js）生成缩略图
- 缩略图尺寸：300x300（等比缩放）
- 原图保留，缩略图用于列表展示

### 6.3 视频处理
- 使用ffmpeg提取视频信息
- 生成视频封面（第一帧）
- 支持在线播放（HLS或MP4）

### 6.4 性能优化
- **前端**：
  - 图片懒加载（Intersection Observer）
  - 虚拟滚动（大量数据时）
  - 路由懒加载
  - 代码分割

- **后端**：
  - 数据库索引优化
  - 分页查询
  - 缓存热门数据（Redis，可选）
  - CDN加速静态资源

---

## 七、安全性设计

### 7.1 认证机制
- JWT Token认证
- Token过期时间：7天
- Refresh Token机制
- 密码使用bcrypt加密（salt rounds: 10）

### 7.2 访问控制
- 所有API接口需要认证（除登录）
- 文件访问需要验证权限
- 防止未授权访问他人文件

### 7.3 文件安全
- 文件类型白名单
- 文件名防注入（清理特殊字符）
- 文件大小限制
- 病毒扫描（可选，云存储自带）

### 7.4 数据安全
- SQL注入防护（Prisma自动处理）
- XSS防护（前端转义）
- CSRF防护（Token验证）
- HTTPS传输（生产环境）

---

## 八、部署方案

### 8.1 开发环境
- 前端：Vite Dev Server（端口5173）
- 后端：Express（端口3000）
- 数据库：PostgreSQL（本地或Docker）

### 8.2 生产环境
- **Docker容器化**：
  - frontend容器（Nginx）
  - backend容器（Node.js）
  - database容器（PostgreSQL）
  
- **Nginx配置**：
  - 反向代理后端API
  - 静态资源服务
  - HTTPS配置
  - 压缩优化

- **PM2进程管理**：
  - 自动重启
  - 日志管理
  - 负载均衡（多实例）

### 8.3 部署步骤
1. 购买云服务器（推荐：阿里云/腾讯云）
2. 安装Docker和Docker Compose
3. 配置域名和SSL证书
4. 配置环境变量
5. 构建Docker镜像
6. 启动容器
7. 配置Nginx
8. 设置自动备份

---

## 九、开发时间估算

| 阶段 | 任务 | 时间 |
|------|------|------|
| 阶段1 | 项目初始化、基础架构 | 1天 |
| 阶段2 | 数据库设计和初始化 | 0.5天 |
| 阶段3 | 后端API开发（认证、上传、查询） | 2-3天 |
| 阶段4 | 前端基础框架和路由 | 1天 |
| 阶段5 | 前端页面开发 | 2-3天 |
| 阶段6 | 前端组件开发（上传、预览） | 2天 |
| 阶段7 | 前后端联调 | 1-2天 |
| 阶段8 | 优化和部署 | 1-2天 |
| **总计** | | **10-14天** |

---

## 十、后续扩展功能（可选）

- 相册功能（分组管理）
- 评论功能
- 点赞/收藏
- 分享功能（生成分享链接）
- 搜索功能（全文搜索）
- 移动端APP（React Native）
- 自动化备份
- 统计分析（访问量、热门标签等）

---

## 十一、技术难点和解决方案

### 11.1 大文件上传
- **问题**：大文件上传可能超时
- **方案**：分片上传（chunk upload），前端分片，后端合并

### 11.2 大量图片加载
- **问题**：页面加载慢
- **方案**：懒加载、虚拟滚动、缩略图、CDN

### 11.3 视频播放兼容性
- **问题**：不同浏览器支持格式不同
- **方案**：提供多种格式（MP4、WebM），使用video.js播放器

### 11.4 存储成本
- **问题**：存储空间和流量成本
- **方案**：压缩图片、视频转码、CDN缓存、定期清理

---

## 十二、环境变量配置

### 后端 .env
```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/photo_sharing

# JWT密钥
JWT_SECRET=your-secret-key-here
JWT_EXPIRE=7d

# 云存储配置（阿里云OSS示例）
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=your-access-key
OSS_ACCESS_KEY_SECRET=your-secret-key
OSS_BUCKET=your-bucket-name
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com

# 文件上传限制
MAX_FILE_SIZE=52428800  # 50MB
ALLOWED_IMAGE_TYPES=image/jpeg,image/png,image/gif,image/webp
ALLOWED_VIDEO_TYPES=video/mp4,video/webm,video/quicktime

# CORS
CORS_ORIGIN=https://yourdomain.com
```

### 前端 .env.production
```env
VITE_API_BASE_URL=https://api.yourdomain.com
VITE_APP_TITLE=照片视频共享
```

---

**下一步**：我将创建任务拆分文档，将整个项目拆分成多个独立的子任务，每个任务都有清晰的prompt描述。

