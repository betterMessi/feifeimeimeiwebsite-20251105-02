# 云端部署指南 - 照片视频共享系统

## 📋 部署方案概览

由于需要上传照片和视频到云端，**必须使用云存储服务**。推荐的部署方案如下：

---

## 🎯 推荐方案：Vercel + Render + 云存储

### 为什么选择这个方案？

1. **Vercel**：前端部署完全免费，无限流量
2. **Render**：后端免费额度充足（750小时/月）
3. **云存储**：专门用于存储照片和视频，成本低、性能好

### 存储需求分析

- **照片平均大小**：2-5MB/张
- **视频平均大小**：10-50MB/个
- **预计使用量**：
  - 100张照片 ≈ 200-500MB
  - 50个视频 ≈ 500MB-2.5GB
  - **总计：约1-3GB**（初期）

---

## 🚀 详细部署步骤

### 第一步：选择云存储服务

#### 方案A：阿里云OSS（推荐，国内访问快）

**优点**：
- 国内访问速度快
- 价格便宜：约0.12元/GB/月
- 稳定可靠
- 有CDN加速

**价格**：
- 存储：0.12元/GB/月
- 流量：0.5元/GB（下载）
- **1GB存储 + 1GB流量 ≈ 0.62元/月**

**注册**：
1. 访问 https://www.aliyun.com
2. 注册账号并实名认证
3. 开通OSS服务

#### 方案B：腾讯云COS（国内，有免费额度）

**优点**：
- **免费额度**：50GB存储空间（6个月）
- 国内访问速度快
- 价格：约0.118元/GB/月

**价格**：
- 存储：0.118元/GB/月
- 流量：0.5元/GB（下载）
- **免费额度内：0元**

**注册**：
1. 访问 https://cloud.tencent.com
2. 注册账号并实名认证
3. 开通COS服务

#### 方案C：七牛云（国内，有免费额度）

**优点**：
- **免费额度**：10GB存储空间（永久）
- 国内访问速度快
- 适合小型项目

**价格**：
- 存储：10GB免费
- 超出：0.12元/GB/月

**注册**：
1. 访问 https://www.qiniu.com
2. 注册账号
3. 开通对象存储服务

#### 方案D：AWS S3（国际，稳定）

**优点**：
- 全球稳定
- 免费额度：5GB存储（12个月）
- 适合国际访问

**价格**：
- 存储：0.023美元/GB/月
- 流量：0.09美元/GB（下载）

---

### 第二步：配置云存储

#### 以阿里云OSS为例：

1. **创建Bucket（存储桶）**
   - 登录阿里云控制台
   - 进入OSS服务
   - 创建Bucket，选择：
     - 地域：选择离你最近的地域（如：华东1-杭州）
     - 读写权限：公共读（或私有，需要签名URL）
     - 存储类型：标准存储

2. **获取AccessKey**
   - 进入"访问控制RAM"
   - 创建子用户，获取：
     - AccessKey ID
     - AccessKey Secret

3. **配置CORS（跨域）**
   - 在Bucket设置中配置CORS规则：
     ```json
     {
       "AllowedOrigins": ["*"],
       "AllowedMethods": ["GET", "POST", "PUT", "DELETE"],
       "AllowedHeaders": ["*"],
       "ExposeHeaders": ["ETag"],
       "MaxAgeSeconds": 3600
     }
     ```

---

### 第三步：修改后端代码集成云存储

#### 安装依赖

```bash
cd backend
npm install @aliyun-sdk/client-oss
# 或腾讯云：npm install cos-nodejs-sdk-v5
# 或七牛云：npm install qiniu
```

#### 创建云存储配置文件

创建 `backend/config/oss.js`：

```javascript
import OSS from '@aliyun-sdk/client-oss';

// 阿里云OSS配置
export const ossConfig = {
  region: 'oss-cn-hangzhou', // 你的Bucket地域
  accessKeyId: process.env.OSS_ACCESS_KEY_ID,
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET,
  bucket: process.env.OSS_BUCKET_NAME || 'your-bucket-name',
};

// 初始化OSS客户端
export const ossClient = new OSS({
  region: ossConfig.region,
  accessKeyId: ossConfig.accessKeyId,
  accessKeySecret: ossConfig.accessKeySecret,
  bucket: ossConfig.bucket,
});
```

#### 修改上传路由

修改 `backend/routes/upload.js`，添加上传到OSS的功能：

```javascript
import { ossClient, ossConfig } from '../config/oss.js';

// 上传到OSS
async function uploadToOSS(filePath, objectName) {
  try {
    const result = await ossClient.put(objectName, filePath);
    return result.url; // 返回OSS的URL
  } catch (error) {
    console.error('上传到OSS失败:', error);
    throw error;
  }
}

// 在文件上传后，调用上传到OSS
router.post('/', upload.array('files', 10), async (req, res) => {
  // ... 现有代码 ...
  
  // 上传到OSS
  const ossUrl = await uploadToOSS(file.path, `uploads/${file.filename}`);
  
  // 保存OSS URL到数据库，而不是本地路径
  const filePath = ossUrl; // 使用OSS URL
});
```

---

### 第四步：部署后端到Render

1. **注册Render账号**
   - 访问 https://render.com
   - 使用GitHub账号登录

2. **创建Web服务**
   - 点击 "New" → "Web Service"
   - 连接GitHub仓库
   - 配置：
     - **Root Directory**: `backend`
     - **Environment**: Node
     - **Build Command**: `npm install`
     - **Start Command**: `npm start`
     - **Plan**: Free（或选择付费计划）

3. **设置环境变量**
   在Render项目设置中添加：
   ```
   OSS_ACCESS_KEY_ID=你的AccessKey ID
   OSS_ACCESS_KEY_SECRET=你的AccessKey Secret
   OSS_BUCKET_NAME=你的Bucket名称
   PORT=3000
   NODE_ENV=production
   ```

4. **获取后端URL**
   - 部署完成后，Render会提供URL：`https://your-app.onrender.com`

---

### 第五步：部署前端到Vercel

1. **注册Vercel账号**
   - 访问 https://vercel.com
   - 使用GitHub账号登录

2. **部署前端**
   - 点击 "New Project"
   - 导入GitHub仓库
   - 配置：
     - **Framework Preset**: Other
     - **Root Directory**: `样式预览`
     - **Build Command**: （留空，因为是静态文件）
     - **Output Directory**: `.`

3. **设置环境变量**
   ```
   VITE_API_BASE_URL=https://your-app.onrender.com/api
   ```

4. **获取前端URL**
   - Vercel会提供URL：`https://your-app.vercel.app`

---

### 第六步：更新前端API地址

修改 `样式预览/script.js`：

```javascript
// 开发环境
const API_BASE_URL = process.env.VITE_API_BASE_URL || 'http://localhost:3000/api';

// 生产环境会自动使用环境变量
```

---

## 💰 成本估算

### 初期（1-3GB存储）

| 服务 | 方案 | 月费用 |
|------|------|--------|
| 前端（Vercel） | 免费 | ¥0 |
| 后端（Render） | 免费 | ¥0 |
| 云存储（阿里云） | 1GB存储 + 1GB流量 | ¥0.62 |
| **总计** | | **¥0.62/月** |

### 中期（10-50GB存储）

| 服务 | 方案 | 月费用 |
|------|------|--------|
| 前端（Vercel） | 免费 | ¥0 |
| 后端（Render） | 免费 | ¥0 |
| 云存储（阿里云） | 10GB存储 + 10GB流量 | ¥6.2 |
| **总计** | | **¥6.2/月** |

### 大型（100GB+存储）

| 服务 | 方案 | 月费用 |
|------|------|--------|
| 前端（Vercel） | 免费 | ¥0 |
| 后端（Render） | Starter ($7/月) | ¥50 |
| 云存储（阿里云） | 100GB存储 + 50GB流量 | ¥37 |
| **总计** | | **¥87/月** |

---

## 🎯 推荐选择

### 如果预算有限（初期）

**推荐**：Vercel + Render + **腾讯云COS**
- 前端：免费
- 后端：免费
- 存储：**50GB免费（6个月）**
- **总成本：¥0/月（前6个月）**

### 如果追求稳定性（长期）

**推荐**：Vercel + Render + **阿里云OSS**
- 前端：免费
- 后端：免费（初期）
- 存储：0.12元/GB/月
- **总成本：约¥1-10/月（根据使用量）**

### 如果国际访问多

**推荐**：Vercel + Render + **AWS S3**
- 前端：免费
- 后端：免费（初期）
- 存储：免费额度5GB（12个月）
- **总成本：¥0/月（前12个月）**

---

## 📝 部署检查清单

- [ ] 注册云存储服务账号
- [ ] 创建Bucket并配置CORS
- [ ] 获取AccessKey
- [ ] 修改后端代码集成云存储
- [ ] 部署后端到Render
- [ ] 设置后端环境变量
- [ ] 部署前端到Vercel
- [ ] 设置前端环境变量
- [ ] 测试文件上传功能
- [ ] 测试文件访问功能

---

## ⚠️ 注意事项

1. **Render免费服务**：
   - 15分钟无活动会自动休眠
   - 首次访问需要等待唤醒（约30秒）
   - 如需24小时运行，需升级到付费计划

2. **云存储安全**：
   - 不要将AccessKey提交到GitHub
   - 使用环境变量存储敏感信息
   - 考虑使用私有Bucket + 签名URL

3. **数据库**：
   - Render的免费服务不提供持久化存储
   - 建议使用外部数据库（如MongoDB Atlas免费版）

4. **文件大小限制**：
   - 当前限制：50MB/文件
   - 如需更大，需调整后端配置和云存储策略

---

## 🆘 需要帮助？

如果部署遇到问题：
1. 查看服务器日志
2. 检查环境变量配置
3. 确认云存储CORS设置
4. 测试API接口是否正常

---

**下一步**：选择云存储服务，开始部署！

